
{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Application ============================ }}
{{! ========================================================== }}
{{! ========================================================== }}
apiVersion: v1                      
kind: Namespace
metadata:
  name: {{{namespace}}}                             
---
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: {{{name}}}
  namespace: {{{namespace}}}
spec:
  componentKinds:
  - group: apps.open-cluster-management.io
    kind: Subscription
  descriptor: {}
  selector:
    matchExpressions:
      - key: app
        operator: In
        values: 
          - {{{name}}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Channel(s) ============================= }}
{{! ========================================================== }}
{{! ========================================================== }}


{{#each channels}}

{{#switch channelType}}

{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Github channel ========================= }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'github'}}
---
apiVersion: apps.open-cluster-management.io/v1
kind: Channel
metadata:
  name: {{{../../name}}}-{{{../channelName}}}
  namespace: {{{../../namespace}}}
spec:
  type: GitHub
  pathname: {{{../githubURL}}} ##channels.{{@index}}.githubURL
{{#if ../githubUser}}
  secretRef:
    name: {{{../../../name}}}-github-authentication-{{@index}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{{../../../name}}}-github-authentication-{{@index}}
  namespace: {{{../../../namespace}}}
data:
  user: {{{../../githubUser}}}
  accessToken: {{{../../githubAccessId}}}
{{/if}}      
---
apiVersion: apps.open-cluster-management.io/v1
kind: Subscription
metadata:
  annotations:
{{#if ../githubBranch}}
    apps.open-cluster-management.io/github-branch: {{{../../githubBranch}}}
{{/if}}
{{#if ../githubPath}}
    apps.open-cluster-management.io/github-path: {{{../../githubPath}}}
{{/if}}
{{#if ../githubCommit}}
    apps.open-cluster-management.io/git-commit: {{{../../githubCommit}}}
{{/if}}
  labels:
    app: {{{../../name}}}
  name: placement-{{{../../name}}}-subscription-{{@index}}
  namespace: {{{../../namespace}}}
spec:
  channel: {{{../../namespace}}}/{{{../../name}}}-{{{../channelName}}}
  placement:
    placementRef:
      kind: PlacementRule
      name: {{{../../name}}}-placement
  
{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Helmrepo channel ==================== }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'helmrepo'}}
  
{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Objectstore channel ==================== }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'objectstore'}}
       
{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Deployable channel ===================== }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'deployable'}}
  
{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Secret channel ========================= }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'secret'}}
  
{{/case}}

{{/switch}}
{{/each}}
  

{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Placement Rule ========================= }}
{{! ========================================================== }}
{{! ========================================================== }}

---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: {{{name}}}-placement
  namespace: {{{namespace}}}
spec:
  clusterSelector:
    matchLabels:
  clusterReplicas:
  {{#if online-cluster-only-checkbox}}
  clusterConditions:
    - type: ManagedClusterConditionAvailable
      status: "True"
  {{/if}}
{{#if timeWindow.mode}}
  timewindow:
    windowtype: {{{timeWindow.mode}}}
    location: {{{timeWindow.timezone}}}
    weekdays: [{{{timeWindow.days}}}]
    hours:
      - start: {{{timeWindow.text}}}
        end: "10:10PM"
{{/if}}
